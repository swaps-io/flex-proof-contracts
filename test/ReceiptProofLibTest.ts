import { describe, it } from 'node:test';
import assert from 'node:assert/strict';

import { network } from 'hardhat';

import { encodeHashiReceiptProof } from './lib/encodeHashiReceiptProof.js';

describe('ReceiptProofLibTest', async function () {
  const { viem } = await network.connect();
  const lib = await viem.deployContract('ReceiptProofLibTest');

  const expectedProof = '0x000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000796922d00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000011c000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000247f90244a0f9ff0f83514b39d941c5b84e2f4f34b92e766bdc61de08a76dc9b14a71e73222a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347944200000000000000000000000000000000000011a0f1b09fb679e6b75e3169883ee999c4e4d3cd4bf95c6572e00ce730a2b732d711a02869278b132da65669ef8dd5a59e1cafb19432e63dd89b53ea61212d97cced4ea03204fb2c7f9acb8cf2af0c7feeff761af2e86b687b42118a458a9810472ab2a7b90100125b78c6f047983080c109c20003600080822088020460090f1ce4046c88533b0d0808083704d04840000072020c3324a15d404152906612503801016a6342cd0c40114c25c820cab225122d4054688a52a884101149061e116482455810080108a9030b62168280154002410082189003201c05237886e405451816294c4018cd24850788000608e011834c88001a281941b606cc3009402834280c0e804c1082108360108598ca8010614a111404202ed102208548408e00d0800018084124c230307608028494aa2903a60443410d90c0719000d4a3090102008e022060a603386ca14471050e298480116802316262182014708880488002b240005501e880840796922d840393870084018c3555846720fe1380a0be75f63a0e2efb12310fb91829a5b2252a882e508a674d7cb8c72eccb62a415688000000000000000082017ca056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a0f0c257dfdcaf31ff962d00afaf90878fc0d01699b610ae334650a942eb716de00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000053f851a043d1a97a67ace1b4fcf400c97b64833e363f929339269b5f08316efe15bb744280808080808080a0c6671ab0c8145b7e995558f60b59fc3ab0afd34db7ba64c70268da26e6f6520780808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f4f901f180a022532ca66e2a83977e663b41605e7e2df76bc896e12fc53dce0c5b95ed7f4367a0fd882e481b284515091c4eace0556fd4bf36261a282c4dbe14a9813af1a73504a04b64fbdf1b5db465262c0c4a07d8d1a69034fff72db3e02d6661743522b7c7d7a0f3e1c56f139f509c3bd8cc1546737d231ee006b4f760f9d754b1ce80b64ceb31a0095b2d77ffa53c424fe4cdaf377d3bea5129bc21e95046f267b0d429bf112405a0156430f22abbf89c225643a24d9a97a7fe5832d15df48ec934f56a5860431a8aa040c1f34f5f45ff6d5a717795fc90d520d5080994a10fc487af7a60557b367c5ca0dd8bd9a505b52c9249dc171eea453972bc5261f876553296c8a6186c20f4143da075f0a228baf7eea3111db5ca77d9901bd99109fa3c0d8d3c0e53280ea92e8ec7a0676127922e8aa2da69ca3fd4802d559275d6fd4f5f51f86801e0fcdbc65cdc0ea0e1af98a5d5db3b2b9beb67e7fe333e669b8bc7c73cac1b6c3f96d68670d87422a06ac3e127bdadf66bd1352a7666934c3ab258bb4483f2d9c285aeec2012fed133a0e64c4cb299540f0ca821a86fa4d0ffdd17ef4f997ad121ebec941cedaf2c9390a0977a40d5cb87002b9d8dbaf25667b3b0dd1bd089b49e6c5de4edc7fd2b45cf5fa064756251d84bca534b9408b1c3b5ed3b415bb06e52ac01d37b6c205ff54e7f43800000000000000000000000000000000000000000000000000000000000000000000000000000000000000adaf90ad720b90ad302f90acf01832fce87b9010000010000000400000000010000020000800000000000400100000000000000000000000000000000000000400000000000000000000000000000000000000000000010002400000000200000000000000000000010010008004000000000000000000200000000800500000000000000000008000100000000000000000000000800010000000200000000000000000008000002000000000000000004000000000080001000080800100000000000000000000000004000000000000000000000100004000000000000000000000000000000000000200000000080020000000010080000010008000000000800100060000000000000000000000000100000f909c4f85a94a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0bf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0bf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000009aa56119ab6bf672e22eea5c4735446101bd46d8f87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0ba000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000009aa56119ab6bf672e22eea5c4735446101bd46d80000000000000000000000000000000000000000000000000000000000000001f85a94b981b2c0c3db52c316d30df76cc48fd167ed87edf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94b981b2c0c3db52c316d30df76cc48fd167ed87edf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000007388755e0a5b867f30168ea89f2d42db2d5cb918f87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000b981b2c0c3db52c316d30df76cc48fd167ed87eda000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000007388755e0a5b867f30168ea89f2d42db2d5cb9180000000000000000000000000000000000000000000000000000000000000001f85a94ca71fa74c9682518ff2489b902648e6c2745573bf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94ca71fa74c9682518ff2489b902648e6c2745573bf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c2260000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e44a29d8d2197e80085986953d52566d10eaacacf87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000ca71fa74c9682518ff2489b902648e6c2745573ba000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab840000000000000000000000000e44a29d8d2197e80085986953d52566d10eaacac0000000000000000000000000000000000000000000000000000000000000001f85a94de8507bb18616ce211638fb898e452f5486b916ef842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94de8507bb18616ce211638fb898e452f5486b916ef842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000007e1306f8adf9125b3795dfefff35c1a80be5ebeef87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000de8507bb18616ce211638fb898e452f5486b916ea000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000007e1306f8adf9125b3795dfefff35c1a80be5ebee000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000010b00000000000000000000000000000000000000000000000000000000000000';

  it('Should encode receipt proof', async function () {
    // Based on: https://github.com/gnosis/hashi/blob/d6a3d5f5a881d0646cff63f4c980854070cbb6f1/packages/evm/test/proofs.ts#L66
    const proof = encodeHashiReceiptProof({
      chainId: 10n,
      blockNumber: 127308333n,
      blockHeader: '0xf90244a0f9ff0f83514b39d941c5b84e2f4f34b92e766bdc61de08a76dc9b14a71e73222a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347944200000000000000000000000000000000000011a0f1b09fb679e6b75e3169883ee999c4e4d3cd4bf95c6572e00ce730a2b732d711a02869278b132da65669ef8dd5a59e1cafb19432e63dd89b53ea61212d97cced4ea03204fb2c7f9acb8cf2af0c7feeff761af2e86b687b42118a458a9810472ab2a7b90100125b78c6f047983080c109c20003600080822088020460090f1ce4046c88533b0d0808083704d04840000072020c3324a15d404152906612503801016a6342cd0c40114c25c820cab225122d4054688a52a884101149061e116482455810080108a9030b62168280154002410082189003201c05237886e405451816294c4018cd24850788000608e011834c88001a281941b606cc3009402834280c0e804c1082108360108598ca8010614a111404202ed102208548408e00d0800018084124c230307608028494aa2903a60443410d90c0719000d4a3090102008e022060a603386ca14471050e298480116802316262182014708880488002b240005501e880840796922d840393870084018c3555846720fe1380a0be75f63a0e2efb12310fb91829a5b2252a882e508a674d7cb8c72eccb62a415688000000000000000082017ca056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b4218080a0f0c257dfdcaf31ff962d00afaf90878fc0d01699b610ae334650a942eb716de0',
      ancestralBlockNumber: 0n,
      ancestralBlockHeaders: [],
      receiptProof: [
        '0xf851a043d1a97a67ace1b4fcf400c97b64833e363f929339269b5f08316efe15bb744280808080808080a0c6671ab0c8145b7e995558f60b59fc3ab0afd34db7ba64c70268da26e6f652078080808080808080',
        '0xf901f180a022532ca66e2a83977e663b41605e7e2df76bc896e12fc53dce0c5b95ed7f4367a0fd882e481b284515091c4eace0556fd4bf36261a282c4dbe14a9813af1a73504a04b64fbdf1b5db465262c0c4a07d8d1a69034fff72db3e02d6661743522b7c7d7a0f3e1c56f139f509c3bd8cc1546737d231ee006b4f760f9d754b1ce80b64ceb31a0095b2d77ffa53c424fe4cdaf377d3bea5129bc21e95046f267b0d429bf112405a0156430f22abbf89c225643a24d9a97a7fe5832d15df48ec934f56a5860431a8aa040c1f34f5f45ff6d5a717795fc90d520d5080994a10fc487af7a60557b367c5ca0dd8bd9a505b52c9249dc171eea453972bc5261f876553296c8a6186c20f4143da075f0a228baf7eea3111db5ca77d9901bd99109fa3c0d8d3c0e53280ea92e8ec7a0676127922e8aa2da69ca3fd4802d559275d6fd4f5f51f86801e0fcdbc65cdc0ea0e1af98a5d5db3b2b9beb67e7fe333e669b8bc7c73cac1b6c3f96d68670d87422a06ac3e127bdadf66bd1352a7666934c3ab258bb4483f2d9c285aeec2012fed133a0e64c4cb299540f0ca821a86fa4d0ffdd17ef4f997ad121ebec941cedaf2c9390a0977a40d5cb87002b9d8dbaf25667b3b0dd1bd089b49e6c5de4edc7fd2b45cf5fa064756251d84bca534b9408b1c3b5ed3b415bb06e52ac01d37b6c205ff54e7f4380',
        '0xf90ad720b90ad302f90acf01832fce87b9010000010000000400000000010000020000800000000000400100000000000000000000000000000000000000400000000000000000000000000000000000000000000010002400000000200000000000000000000010010008004000000000000000000200000000800500000000000000000008000100000000000000000000000800010000000200000000000000000008000002000000000000000004000000000080001000080800100000000000000000000000004000000000000000000000100004000000000000000000000000000000000000200000000080020000000010080000010008000000000800100060000000000000000000000000100000f909c4f85a94a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0bf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0bf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000009aa56119ab6bf672e22eea5c4735446101bd46d8f87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000a8d3c1e744fcc68c893a32a9f19a49d5bc76fd0ba000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000009aa56119ab6bf672e22eea5c4735446101bd46d80000000000000000000000000000000000000000000000000000000000000001f85a94b981b2c0c3db52c316d30df76cc48fd167ed87edf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94b981b2c0c3db52c316d30df76cc48fd167ed87edf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000007388755e0a5b867f30168ea89f2d42db2d5cb918f87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000b981b2c0c3db52c316d30df76cc48fd167ed87eda000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000007388755e0a5b867f30168ea89f2d42db2d5cb9180000000000000000000000000000000000000000000000000000000000000001f85a94ca71fa74c9682518ff2489b902648e6c2745573bf842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94ca71fa74c9682518ff2489b902648e6c2745573bf842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c2260000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e44a29d8d2197e80085986953d52566d10eaacacf87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000ca71fa74c9682518ff2489b902648e6c2745573ba000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab840000000000000000000000000e44a29d8d2197e80085986953d52566d10eaacac0000000000000000000000000000000000000000000000000000000000000001f85a94de8507bb18616ce211638fb898e452f5486b916ef842a0ecdf3a3effea5783a3c4c2140e677577666428d44ed9d474a0b3a4c9943f8440a000000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22680f9011b94de8507bb18616ce211638fb898e452f5486b916ef842a0141df868a6331af528e38c83b7aa03edc19be66e37ae67f9285bf4f8e3c6a1a8a00000000000000000000000004e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67b8c0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002dd68b007b46fbe91b9a7c3eda5a7a1063cb5b4700000000000000000000000075cf11467937ce3f2f357ce24ffc3dbf8fd5c22600000000000000000000000000000000000000000000000000000000000000010000000000000000000000007e1306f8adf9125b3795dfefff35c1a80be5ebeef87a944e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec67f842a04f51faf6c4561ff95f067657e43439f0f856d97c04d9ec9070a6199ad418e235a0000000000000000000000000de8507bb18616ce211638fb898e452f5486b916ea000000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762f8799424f6f36a551fe6008fa80afcff1d6ace182ead2be1a0db3dd2da8ea81566d4f4c29c152977ba57d38e7eed4b61fb95dfaceb177409bab8400000000000000000000000007e1306f8adf9125b3795dfefff35c1a80be5ebee0000000000000000000000000000000000000000000000000000000000000001',
      ],
      transactionIndex: '0x0b',
      logIndex: 4n,
    });
    assert.equal(proof, expectedProof);
  });

  it('Should decode receipt proof in lib', async function () {
    await lib.read.test_decodeKnownProof([
      '0x1337133713371337133713371337133713371337133713371337133713371337',
      'Hello World! Hello World! Hello World! Hello World! Hello World! Hello World! Hello World! Hello World! Hello World!',
      11111111111n,
      expectedProof,
      '0x999888777666555444333222111000',
      '0x0011223344556677',
      148,
    ]);
  });
});
